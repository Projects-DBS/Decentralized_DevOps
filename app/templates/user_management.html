<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management - DCICD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container my-5" style="max-width:480px;">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex mb-3">
                <button id="signupTab" type="button" class="btn btn-outline-primary flex-fill me-2 active">Registration</button>
                <button id="deleteTab" type="button" class="btn btn-outline-secondary flex-fill">Remove User</button>
            </div>
            <div id="signupSection">
                <h3 class="mb-3 text-center">Registration</h3>
                <form id="newUserForm" autocomplete="off">
                    <div class="mb-2">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" class="form-control" minlength="6" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">First Name</label>
                        <input type="text" name="first_name" class="form-control" minlength="3" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Last Name</label>
                        <input type="text" name="last_name" class="form-control" minlength="3" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Role</label>
                        <select name="role" id="userRole" class="form-select" required>
                            <option value="">Select a role</option>
                        </select>
                        <div id="roleDetails" class="form-text"></div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Organization</label>
                        <select name="organization" id="userOrg" class="form-select" required>
                            <option value="">Select an organization</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Contact</label>
                        <input type="tel" name="contact" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Select the Public Key (.pub)</label>
                        <input type="file" id="keyFile" class="form-control" accept=".pub" required>
                        <div id="keyStatus" class="form-text"></div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Enter a Password</label>
                        <input type="password" name="password" class="form-control" minlength="8" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" name="confirm_password" class="form-control" minlength="8" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Operations</label>
                        <div id="operationList"></div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Page Access</label>
                        <div id="pageList"></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-2">Register</button>
                    <div id="signupStatus" class="text-center mt-2"></div>
                </form>
            </div>
            <div id="deleteSection" style="display:none;">
                <h3 class="mb-3 text-center">Remove a User</h3>
                <div class="mb-3">
                    <label class="form-label">Select a User</label>
                    <select id="userDropdown" class="form-select">
                        <option value="">Select a user</option>
                    </select>
                </div>
                <button id="deleteButton" class="btn btn-danger w-100" disabled>Remove User</button>
                <div id="deleteStatus" class="text-center mt-2"></div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
var keyContent = "";
var roleMapping = {};

document.getElementById('signupTab').addEventListener('click', function() {
    document.getElementById('signupSection').style.display = "";
    document.getElementById('deleteSection').style.display = "none";
    this.classList.add("active");
    document.getElementById('deleteTab').classList.remove("active");
});

document.getElementById('deleteTab').addEventListener('click', function() {
    document.getElementById('signupSection').style.display = "none";
    document.getElementById('deleteSection').style.display = "";
    this.classList.add("active");
    document.getElementById('signupTab').classList.remove("active");
    getUserData();
});

fetch('/roles')
    .then(function(response) {
        return response.json();
    })
    .then(function(roleData) {
        var dropdown = document.getElementById('userRole');
        dropdown.innerHTML = '<option value="">Select role</option>';
        
        for (var i = 0; i < roleData.length; i++) {
            var roleObject = roleData[i];
            var roleName = Object.keys(roleObject)[0];
            var roleLabel = roleName.charAt(0).toUpperCase() + roleName.slice(1);
            dropdown.innerHTML += '<option value="' + roleName + '">' + roleLabel + '</option>';
            roleMapping[roleName] = roleObject[roleName].join(", ");
        }
    });

document.getElementById('userRole').addEventListener('change', function() {
    var infoDiv = document.getElementById('roleDetails');
    if (this.value && roleMapping[this.value]) {
        infoDiv.textContent = "Includes: " + roleMapping[this.value];
    } else {
        infoDiv.textContent = "";
    }
});

fetch('/organizations')
    .then(function(response) {
        return response.json();
    })
    .then(function(orgData) {
        var dropdown = document.getElementById('userOrg');
        dropdown.innerHTML = '<option value="">Select organization</option>';
        
        for (var i = 0; i < orgData.length; i++) {
            dropdown.innerHTML += '<option value="' + orgData[i] + '">' + orgData[i] + '</option>';
        }
    });

fetch('/registration_parameter')
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        var checkboxHTML = '';
        var operations = data.operations || [];
        
        for (var i = 0; i < operations.length; i++) {
            checkboxHTML += '<div class="form-check">' +
                           '<input class="form-check-input" type="checkbox" name="operations" value="' + operations[i] + '">' +
                           '<label class="form-check-label">' + operations[i] + '</label>' +
                           '</div>';
        }
        document.getElementById('operationList').innerHTML = checkboxHTML;
    });

fetch('/registration_parameter_pages')
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        var checkboxHTML = '';
        var pages = data.page_access || [];
        
        for (var i = 0; i < pages.length; i++) {
            checkboxHTML += '<div class="form-check">' +
                           '<input class="form-check-input" type="checkbox" name="page_access" value="' + pages[i] + '">' +
                           '<label class="form-check-label">' + pages[i] + '</label>' +
                           '</div>';
        }
        document.getElementById('pageList').innerHTML = checkboxHTML;
    });

document.getElementById('keyFile').addEventListener('change', function(event) {
    var selectedFile = event.target.files[0];
    var statusDiv = document.getElementById('keyStatus');
    keyContent = '';
    statusDiv.textContent = '';
    
    if (!selectedFile) return;
    
    if (!selectedFile.name.endsWith('.pub')) {
        statusDiv.textContent = "Please select a .pub file.";
        return;
    }
    
    var fileReader = new FileReader();
    fileReader.addEventListener('load', function(loadEvent) {
        keyContent = loadEvent.target.result;
        statusDiv.textContent = "Loaded: " + selectedFile.name;
    });
    fileReader.readAsText(selectedFile);
});

document.getElementById('newUserForm').addEventListener('submit', function(event) {
    event.preventDefault();
    var formData = event.target;
    var statusDiv = document.getElementById('signupStatus');
    statusDiv.textContent = '';
    
    if (formData.username.value.trim().length < 6) { 
        statusDiv.textContent = "Username at least 6 chars"; 
        return; 
    }
    
    if (formData.first_name.value.trim().length < 3) { 
        statusDiv.textContent = "First name at least 3 chars"; 
        return; 
    }
    
    if (formData.last_name.value.trim().length < 3) { 
        statusDiv.textContent = "Last name at least 3 chars"; 
        return; 
    }
    
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(formData.email.value.trim())) { 
        statusDiv.textContent = "Invalid email"; 
        return; 
    }
    
    var phoneRegex = /^\d{10}$/;
    if (!phoneRegex.test(formData.contact.value.trim())) { 
        statusDiv.textContent = "Contact must be 10 digits"; 
        return; 
    }
    
    if (!keyContent) { 
        statusDiv.textContent = "Upload .pub file"; 
        return; 
    }
    
    if (formData.password.value.length < 8) { 
        statusDiv.textContent = "Password min 8 chars"; 
        return; 
    }
    
    if (formData.password.value !== formData.confirm_password.value) { 
        statusDiv.textContent = "Passwords don't match"; 
        return; 
    }
    
    var selectedOperations = formData.querySelectorAll('input[name="operations"]:checked');
    if (selectedOperations.length < 1) { 
        statusDiv.textContent = "Select at least one operation"; 
        return; 
    }
    
    var selectedPages = formData.querySelectorAll('input[name="page_access"]:checked');
    if (selectedPages.length < 1) { 
        statusDiv.textContent = "Select at least one page"; 
        return; 
    }
    
    var operationValues = [];
    for (var i = 0; i < selectedOperations.length; i++) {
        operationValues.push(selectedOperations[i].value);
    }
    
    var pageValues = [];
    for (var j = 0; j < selectedPages.length; j++) {
        pageValues.push(selectedPages[j].value);
    }
    
    var submitData = {
        username: formData.username.value.trim(),
        first_name: formData.first_name.value.trim(),
        last_name: formData.last_name.value.trim(),
        role: formData.role.value,
        organization: formData.organization.value,
        email: formData.email.value.trim(),
        contact: formData.contact.value.trim(),
        password: formData.password.value,
        operations: operationValues,
        page_access: pageValues,
        public_key: keyContent
    };
    
    fetch('/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(submitData)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(result) {
        statusDiv.textContent = result.message || (result.success ? "Registered!" : "Error");
        if (result.success) {
            formData.reset();
            keyContent = '';
            document.getElementById('keyStatus').textContent = '';
            alert("User Registered!");
        }
    })
    .catch(function() {
        statusDiv.textContent = "Registration failed";
    });
});

function getUserData() {
    fetch('/list_all_users')
        .then(function(response) {
            return response.json();
        })
        .then(function(userData) {
            var dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '<option value="">Select a user</option>';
            
            var users = userData || [];
            for (var i = 0; i < users.length; i++) {
                dropdown.innerHTML += '<option value="' + users[i].username + '">' + users[i].username + '</option>';
            }
            
            document.getElementById('deleteButton').disabled = true;
        });
}

document.getElementById('userDropdown').addEventListener('change', function() {
    document.getElementById('deleteButton').disabled = !this.value;
    document.getElementById('deleteStatus').textContent = '';
});

document.getElementById('deleteButton').addEventListener('click', function() {
    var selectedUser = document.getElementById('userDropdown').value;
    var statusDiv = document.getElementById('deleteStatus');
    
    if (!selectedUser) return;
    
    if (!confirm("Remove user '" + selectedUser + "'?")) return;
    
    fetch('/remove-user', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username: selectedUser})
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(result) {
        statusDiv.textContent = result.message || (result.success ? "User removed" : "Error");
        getUserData();
        document.getElementById('deleteButton').disabled = true;
    })
    .catch(function() {
        statusDiv.textContent = "Error deleting user.";
    });
});
</script>
</body>
</html>