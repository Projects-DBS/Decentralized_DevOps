<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management - DCICD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container my-5" style="max-width:480px;">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex mb-3">
                <button id="regNav" type="button" class="btn btn-outline-primary flex-fill me-2 active">Registration</button>
                <button id="removeNav" type="button" class="btn btn-outline-secondary flex-fill">Remove User</button>
            </div>


            <div id="registrationSection">
                <h3 class="mb-3 text-center">Registration</h3>
                <form id="regForm" autocomplete="off">
                    <div class="mb-2">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" class="form-control" minlength="6" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">First Name</label>
                        <input type="text" name="first_name" class="form-control" minlength="3" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Last Name</label>
                        <input type="text" name="last_name" class="form-control" minlength="3" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Role</label>
                        <select name="role" id="roleSelect" class="form-select" required>
                            <option value="">Select a role</option>
                        </select>
                        <div id="roleInfo" class="form-text"></div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Organization</label>
                        <select name="organization" id="orgSelect" class="form-select" required>
                            <option value="">Select an organization</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Contact</label>
                        <input type="tel" name="contact" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Select the Public Key (.pub)</label>
                        <input type="file" id="publicKeyInput" class="form-control" accept=".pub" required>
                        <div id="pubkey-filename" class="form-text"></div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Enter a Password</label>
                        <input type="password" name="password" class="form-control" minlength="8" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" name="confirm_password" class="form-control" minlength="8" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Operations</label>
                        <div id="operations"></div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Page Access</label>
                        <div id="pages"></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-2">Register</button>
                    <div id="reg-message" class="text-center mt-2"></div>
                </form>
            </div>


            <div id="removeUserSection" style="display:none;">
                <h3 class="mb-3 text-center">Remove a User</h3>
                <div class="mb-3">
                    <label class="form-label">Select a User</label>
                    <select id="userSelect" class="form-select">
                        <option value="">Select a user</option>
                    </select>
                </div>
                <button id="removeBtn" class="btn btn-danger w-100" disabled>Remove User</button>
                <div id="remove-message" class="text-center mt-2"></div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>


let publicKeyText = "";
let ROLE_MAP = {};


document.getElementById('regNav').onclick = function() {
    document.getElementById('registrationSection').style.display = "";
    document.getElementById('removeUserSection').style.display = "none";
    this.classList.add("active");
    document.getElementById('removeNav').classList.remove("active");
};
document.getElementById('removeNav').onclick = function() {
    document.getElementById('registrationSection').style.display = "none";
    document.getElementById('removeUserSection').style.display = "";
    this.classList.add("active");
    document.getElementById('regNav').classList.remove("active");
    loadUserList();
};


fetch('/roles').then(r=>r.json()).then(roles=>{
    let select = document.getElementById('roleSelect');
    select.innerHTML = '<option value="">Select role</option>';
    roles.forEach(roleObj => {
        let role = Object.keys(roleObj)[0];
        let label = role.charAt(0).toUpperCase() + role.slice(1);
        select.innerHTML += `<option value="${role}">${label}</option>`;
        ROLE_MAP[role] = roleObj[role].join(", ");
    });
});
document.getElementById('roleSelect').onchange = function() {
    let info = document.getElementById('roleInfo');
    info.textContent = this.value && ROLE_MAP[this.value] ? "Includes: "+ROLE_MAP[this.value] : "";
};



fetch('/organizations').then(r=>r.json()).then(orgs=>{
    let sel = document.getElementById('orgSelect');
    sel.innerHTML = '<option value="">Select organization</option>';
    orgs.forEach(org => {
        sel.innerHTML += `<option value="${org}">${org}</option>`;
    });
});



fetch('/registration_parameter').then(r=>r.json()).then(d=>{
    let box = '';
    (d.operations||[]).forEach(op=>{
        box += `<div class="form-check">
            <input class="form-check-input" type="checkbox" name="operations" value="${op}">
            <label class="form-check-label">${op}</label>
        </div>`;
    });
    document.getElementById('operations').innerHTML = box;
});
fetch('/registration_parameter_pages').then(r=>r.json()).then(d=>{
    let box = '';
    (d.page_access||[]).forEach(p=>{
        box += `<div class="form-check">
            <input class="form-check-input" type="checkbox" name="page_access" value="${p}">
            <label class="form-check-label">${p}</label>
        </div>`;
    });
    document.getElementById('pages').innerHTML = box;
});



document.getElementById('publicKeyInput').onchange = function(e) {
    let file = e.target.files[0];
    let info = document.getElementById('pubkey-filename');
    publicKeyText = '';
    info.textContent = '';
    if(!file) return;
    if(!file.name.endsWith('.pub')) {
        info.textContent = "Please select a .pub file.";
        return;
    }
    let reader = new FileReader();
    reader.onload = function(ev) {
        publicKeyText = ev.target.result;
        info.textContent = "Loaded: " + file.name;
    };
    reader.readAsText(file);
};



document.getElementById('regForm').onsubmit = function(e){
    e.preventDefault();
    let f = e.target;
    let msg = document.getElementById('reg-message');
    msg.textContent = '';

    if(f.username.value.trim().length < 6) { msg.textContent = "Username at least 6 chars"; return; }
    if(f.first_name.value.trim().length < 3) { msg.textContent = "First name at least 3 chars"; return; }
    if(f.last_name.value.trim().length < 3) { msg.textContent = "Last name at least 3 chars"; return; }
    let emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!emailPattern.test(f.email.value.trim())) { msg.textContent = "Invalid email"; return; }
    let phonePattern = /^\d{10}$/;
    if(!phonePattern.test(f.contact.value.trim())) { msg.textContent = "Contact must be 10 digits"; return; }
    if(!publicKeyText) { msg.textContent = "Upload .pub file"; return; }
    if(f.password.value.length < 8) { msg.textContent = "Password min 8 chars"; return; }
    if(f.password.value !== f.confirm_password.value) { msg.textContent = "Passwords don't match"; return; }
    let checkedOps = Array.from(f.querySelectorAll('input[name="operations"]:checked'));
    if(checkedOps.length < 1) { msg.textContent = "Select at least one operation"; return; }
    let checkedPages = Array.from(f.querySelectorAll('input[name="page_access"]:checked'));
    if(checkedPages.length < 1) { msg.textContent = "Select at least one page"; return; }


    let data = {
        username: f.username.value.trim(),
        first_name: f.first_name.value.trim(),
        last_name: f.last_name.value.trim(),
        role: f.role.value,
        organization: f.organization.value,
        email: f.email.value.trim(),
        contact: f.contact.value.trim(),
        password: f.password.value,
        operations: checkedOps.map(x=>x.value),
        page_access: checkedPages.map(x=>x.value),
        public_key: publicKeyText
    };

    fetch('/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
    })
    .then(r=>r.json())
    .then(resp=>{
        msg.textContent = resp.message || (resp.success ? "Registered!" : "Error");
        if(resp.success) {
            f.reset();
            publicKeyText = '';
            document.getElementById('pubkey-filename').textContent = '';
            alert("User Registered!");
        }
    })
    .catch(e=>{
        msg.textContent = "Registration failed";
    });
};


function loadUserList() {
    fetch('/list_all_users').then(r=>r.json()).then(users=>{
        let sel = document.getElementById('userSelect');
        sel.innerHTML = '<option value="">Select a user</option>';
        (users||[]).forEach(u=>{
            sel.innerHTML += `<option value="${u.username}">${u.username}</option>`;
        });
        document.getElementById('removeBtn').disabled = true;
    });
}
document.getElementById('userSelect').onchange = function() {
    document.getElementById('removeBtn').disabled = !this.value;
    document.getElementById('remove-message').textContent = '';
};
document.getElementById('removeBtn').onclick = function() {
    let user = document.getElementById('userSelect').value;
    let msg = document.getElementById('remove-message');
    if(!user) return;
    if(!confirm("Remove user '"+user+"'?")) return;
    fetch('/remove-user', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username:user})
    })
    .then(r=>r.json())
    .then(resp=>{
        msg.textContent = resp.message || (resp.success ? "User removed" : "Error");
        loadUserList();
        document.getElementById('removeBtn').disabled = true;
    })
    .catch(()=>{ msg.textContent = "Error deleting user."; });
};
</script>
</body>
</html>
