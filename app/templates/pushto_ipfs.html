<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Push a Project - DCICD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
  <div class="bg-white rounded shadow p-4 mx-auto" style="max-width:400px;">
    <h2 class="mb-4 text-center">Push to Decentralized Repository</h2>

    <table id="servers-table" class="table table-bordered text-center mb-3" style="display:none;">
      <thead>
        <tr>
          <th>Server Name</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="servers-tbody"></tbody>
    </table>
    <div id="no-servers" class="text-secondary text-center mb-3">Loading…</div>

    <form id="pushForm" autocomplete="off">
      <div class="mb-3">
        <input type="file" name="zipfile" class="form-control" accept=".zip" required>
      </div>
      <div class="mb-3">
        <input type="password" id="zip_password" name="zip_password" class="form-control mb-2" placeholder="Encryption Password" required>
        <input type="password" id="zip_password_confirm" class="form-control" placeholder="Confirm Password" required>
        <div class="form-text">
          Password must be at least 8 characters, contain a letter and a number.
        </div>
        <div id="password-error" class="text-danger small" style="display:none;"></div>
      </div>
      <button type="submit" class="btn btn-primary w-100">Upload</button>
    </form>

    <div id="out" class="mt-3 text-success text-center small"></div>
  </div>
</div>

<script>
fetch('/list-active-server').then(r=>r.json()).then(data=>{
  let table = document.getElementById('servers-table');
  let tbody = document.getElementById('servers-tbody');
  let msg = document.getElementById('no-servers');
  tbody.innerHTML = "";
  table.style.display = "none";
  msg.textContent = "Loading…";
  if (data.servers && data.servers.length) {
    data.servers.forEach(s=>{
      tbody.innerHTML += "<tr><td>"+s.name+"</td><td>"+(s.status||"Online")+"</td></tr>";
    });
    table.style.display = "";
    msg.textContent = "";
  } else {
    msg.textContent = 'No online servers.';
  }
}).catch(()=>{
  document.getElementById('no-servers').textContent = 'Error loading servers.';
});

function validatePassword(pw) {
  if (pw.length < 8) return 'At least 8 characters required.';
  if (!/[A-Za-z]/.test(pw)) return 'At least one letter required.';
  if (!/[0-9]/.test(pw)) return 'At least one number required.';
  return '';
}

document.getElementById('pushForm').onsubmit = function(e) {
  e.preventDefault();
  let pw = document.getElementById('zip_password').value;
  let pw2 = document.getElementById('zip_password_confirm').value;
  let errorDiv = document.getElementById('password-error');
  errorDiv.style.display = "none";
  let err = validatePassword(pw);
  if (err) { errorDiv.textContent = err; errorDiv.style.display = "block"; return; }
  if (pw !== pw2) { errorDiv.textContent = "Passwords do not match."; errorDiv.style.display = "block"; return; }
  let out = document.getElementById('out');
  out.textContent = 'Uploading...';
  let fd = new FormData(this);
  fetch('/pushto_ipfs', { method:'POST', body:fd })
    .then(r=>r.json())
    .then(data=>{
      if (data.success) {
        out.textContent = "The project has been pushed successfully to the Repo.";
      } else {
        out.textContent = "Error: " + (data.error || "Upload failed.");
      }
    }).catch(()=>{
      out.textContent = 'Error: Upload failed.';
    });
};
</script>
</body>
</html>
