<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Push a Project - DCICD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="bg-white rounded shadow p-4 mx-auto" style="max-width:400px;">
    <h2 class="mb-4 text-center">Push to Decentralized Repository</h2>
    <table id="serverTable" class="table table-bordered text-center mb-3" style="display:none;">
      <thead>
        <tr>
          <th>Server Name</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="serverBody"></tbody>
    </table>
    <div id="serverMessage" class="text-secondary text-center mb-3">Loading…</div>
    <form id="uploadForm" autocomplete="off">
      <div class="mb-3">
        <input type="file" name="zipfile" class="form-control" accept=".zip" required>
      </div>
      <div class="mb-3">
        <input type="password" id="mainPassword" name="zip_password" class="form-control mb-2" placeholder="Encryption Password" required>
        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm Password" required>
        <div class="form-text">
          Password must be at least 8 characters, contain a letter and a number.
        </div>
        <div id="passError" class="text-danger small" style="display:none;"></div>
      </div>
      <button type="submit" class="btn btn-primary w-100">Upload</button>
    </form>
    <div id="uploadStatus" class="mt-3 text-success text-center small"></div>
  </div>
</div>
<script>
fetch('/list-active-server')
  .then(function(response) {
    return response.json();
  })
  .then(function(data) {
    var serverTable = document.getElementById('serverTable');
    var serverBody = document.getElementById('serverBody');
    var messageDiv = document.getElementById('serverMessage');
    
    serverBody.innerHTML = "";
    serverTable.style.display = "none";
    messageDiv.textContent = "Loading…";
    
    if (data.servers && data.servers.length) {
      for (var i = 0; i < data.servers.length; i++) {
        var server = data.servers[i];
        var statusText = server.status || "Online";
        serverBody.innerHTML += "<tr><td>" + server.name + "</td><td>" + statusText + "</td></tr>";
      }
      serverTable.style.display = "";
      messageDiv.textContent = "";
    } else {
      messageDiv.textContent = 'No online servers.';
    }
  })
  .catch(function() {
    document.getElementById('serverMessage').textContent = 'Error loading servers.';
  });

function checkPasswordStrength(password) {
  if (password.length < 8) return 'At least 8 characters required.';
  if (!/[A-Za-z]/.test(password)) return 'At least one letter required.';
  if (!/[0-9]/.test(password)) return 'At least one number required.';
  return '';
}

document.getElementById('uploadForm').addEventListener('submit', function(event) {
  event.preventDefault();
  
  var firstPassword = document.getElementById('mainPassword').value;
  var secondPassword = document.getElementById('confirmPassword').value;
  var errorBox = document.getElementById('passError');
  
  errorBox.style.display = "none";
  
  var validationError = checkPasswordStrength(firstPassword);
  if (validationError) { 
    errorBox.textContent = validationError; 
    errorBox.style.display = "block"; 
    return; 
  }
  
  if (firstPassword !== secondPassword) { 
    errorBox.textContent = "Passwords do not match."; 
    errorBox.style.display = "block"; 
    return; 
  }
  
  var statusDiv = document.getElementById('uploadStatus');
  statusDiv.textContent = 'Uploading...';
  
  var formData = new FormData(this);
  
  fetch('/pushto_ipfs', { 
    method: 'POST', 
    body: formData 
  })
  .then(function(response) {
    return response.json();
  })
  .then(function(result) {
    if (result.success) {
      statusDiv.textContent = "The project has been pushed successfully to the Repo.";
    } else {
      statusDiv.textContent = "Error: " + (result.error || "Upload failed.");
    }
  })
  .catch(function() {
    statusDiv.textContent = 'Error: Upload failed.';
  });
});
</script>
</body>
</html>