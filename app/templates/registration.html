<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registration Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; }
        .container { max-width: 440px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.08);}
        h2 { text-align: center; color: #234;}
        label { display: block; margin: 16px 0 8px 0; color: #333; font-weight: 500;}
        input[type="text"], input[type="email"], input[type="tel"], input[type="password"] {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;
        }
        .checkbox-group { margin: 5px 0 12px 0;}
        .checkbox-group label { display: block; font-weight: 400;}
        .checkbox-group input[type="checkbox"] { margin-right: 6px;}
        button { width: 100%; padding: 12px; background: #3477f5; color: #fff; border: none; border-radius: 5px; font-size: 17px; margin-top: 18px;}
        button:hover { background: #2657b5; }
    </style>
</head>
<body>
<div class="container">
    <h2>Registration</h2>
    <form id="regForm">
        <label>Username</label>
        <input type="text" name="username" required>
        <label>First Name</label>
        <input type="text" name="first_name" required>
        <label>Last Name</label>
        <input type="text" name="last_name" required>
        <label>Role</label>
        <input type="text" name="role" required>
        <label>Organization</label>
        <input type="text" name="organization" required>
        <label>Email</label>
        <input type="email" name="email" required>
        <label>Contact</label>
        <input type="tel" name="contact" required>

        <label>Password</label>
        <input type="password" name="password" required minlength="6">
        <label>Confirm Password</label>
        <input type="password" name="confirm_password" required minlength="6">

        <label>Operations</label>
        <div class="checkbox-group" id="operations"></div>
        <label>Page Access</label>
        <div class="checkbox-group" id="pages"></div>
        <button type="submit">Register</button>
    </form>
</div>
<script>
window.onload = function() {
    fetch('/registration_parameter')
    .then(r=>r.json()).then(d=>{
        let ops = d.operations || [];
        let box = '';
        for(let i=0;i<ops.length;i++){
            box += '<label><input type="checkbox" name="operations" value="'+ops[i]+'">'+ops[i]+'</label>';
        }
        document.getElementById('operations').innerHTML = box;
    });
    fetch('/registration_parameter_pages')
    .then(r=>r.json()).then(d=>{
        let pages = d.page_access || [];
        let box = '';
        for(let i=0;i<pages.length;i++){
            box += '<label><input type="checkbox" name="page_access" value="'+pages[i]+'">'+pages[i]+'</label>';
        }
        document.getElementById('pages').innerHTML = box;
    });
    document.getElementById('regForm').onsubmit = function(e){
        e.preventDefault();
        let f = e.target;
        let pw = f.password.value;
        let cpw = f.confirm_password.value;
        if(!pw || !cpw) {
            alert("Password fields cannot be empty.");
            return;
        }
        if(pw.length < 6) {
            alert("Password should be at least 6 characters.");
            return;
        }
        if(pw !== cpw) {
            alert("Passwords do not match.");
            return;
        }
        let data = {
            username: f.username.value,
            first_name: f.first_name.value,
            last_name: f.last_name.value,
            role: f.role.value,
            organization: f.organization.value,
            email: f.email.value,
            contact: f.contact.value,
            password: pw,
            operations: [],
            page_access: []
        };
        let ops = f.querySelectorAll('input[name="operations"]:checked');
        for(let i=0;i<ops.length;i++){ data.operations.push(ops[i].value); }
        let pags = f.querySelectorAll('input[name="page_access"]:checked');
        for(let i=0;i<pags.length;i++){ data.page_access.push(pags[i].value); }
        fetch('/register', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => {
            const type = response.headers.get("Content-Type") || "";
            if (type.includes("application/json")) {
                return response.json().then(resp => {
                    alert(resp.message || "Registered!");
                    if(resp.success) f.reset();
                });
            } else if (type.includes("application/octet-stream") || type.includes("application/")) {
                // It's a file, let's download it
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.username + '.pvt';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    alert("Registration successful! Key downloaded.");
                    f.reset();
                });
            } else {
                return response.text().then(txt => alert("Unknown response: " + txt));
            }
        })
        .catch(e => {
            alert("Registration failed: " + e.message);
        });
    }
}
</script>
</body>
</html>
