<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CI Trigger</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; }
    .container { max-width: 440px; margin: 50px auto; background: #fff; padding: 32px; border-radius: 12px; box-shadow: 0 4px 12px #ccc; }
    label { display: block; margin-top: 16px; font-weight: 500; }
    select, input, button { width: 100%; padding: 9px; margin-top: 6px; margin-bottom: 12px; border-radius: 7px; border: 1px solid #bbb; }
    button { background: #3477f5; color: #fff; border: none; font-size: 16px; cursor: pointer; font-weight: 600;}
    button:hover { background: #2657b5;}
    .error { color: #b00; margin-top: 10px; font-weight: 500;}
    .flash { color: #008e3a; margin-top: 10px; font-weight: 500;}
    .pw-hint { font-size: 13px; color: #888; margin-top: -10px; margin-bottom: 10px;}
  </style>
</head>
<body>
  <div class="container">
    <h2>CI Trigger</h2>
    <form id="ciForm" autocomplete="off">
      <label for="project">Project</label>
      <select id="project" required>
        <option value="">Select Project</option>
      </select>
      <label for="tag">Tag</label>
      <select id="tag" required>
        <option value="">Select Tag</option>
      </select>
      <label for="version">Version</label>
      <select id="version" required>
        <option value="">Select Version</option>
      </select>

      <!-- Project zip password section -->
      <label for="pzip_password">Project Zip Password</label>
      <input type="password" id="pzip_password" required placeholder="Password to decrypt project zip">
      <label for="pzip_password2">Confirm Project Zip Password</label>
      <input type="password" id="pzip_password2" required placeholder="Confirm project zip password">

      <!-- Build zip password section -->
      <label for="zip_password">Build Zip Password</label>
      <input type="password" id="zip_password" required placeholder="Password to encrypt build zip">
      <label for="zip_password2">Confirm Build Zip Password</label>
      <input type="password" id="zip_password2" required placeholder="Confirm build zip password">

      <div class="pw-hint">
        Passwords must be at least 8 characters and include uppercase, lowercase, a number, and a special character.
      </div>

      <button type="submit">Trigger CI</button>
    </form>
    <div id="msg"></div>
  </div>
  <script>
    let allProjects = [];
    function showError(msg) {
      document.getElementById('msg').textContent = msg;
      document.getElementById('msg').className = 'error';
    }
    function showFlash(msg) {
      document.getElementById('msg').textContent = msg;
      document.getElementById('msg').className = 'flash';
    }

    function loadAllProjects() {
      fetch('/project_info', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          allProjects = Array.isArray(data) ? data : (data.projects || []);
          fillProjectsDropdown();
        });
    }

    function fillProjectsDropdown() {
      const projectSelect = document.getElementById('project');
      projectSelect.innerHTML = '<option value="">Select Project</option>';
      [...new Set(allProjects.map(p => p.project_name))].forEach(name => {
        projectSelect.innerHTML += `<option value="${name}">${name}</option>`;
      });
      document.getElementById('tag').innerHTML = '<option value="">Select Tag</option>';
      document.getElementById('version').innerHTML = '<option value="">Select Version</option>';
    }
    function fillTagsDropdown(projectName) {
      const tagSelect = document.getElementById('tag');
      tagSelect.innerHTML = '<option value="">Select Tag</option>';
      [...new Set(allProjects.filter(p => p.project_name === projectName).map(p => p.tag))]
        .forEach(tag => { tagSelect.innerHTML += `<option value="${tag}">${tag}</option>`; });
      document.getElementById('version').innerHTML = '<option value="">Select Version</option>';
    }
    function fillVersionsDropdown(projectName, tag) {
      const verSelect = document.getElementById('version');
      verSelect.innerHTML = '<option value="">Select Version</option>';
      [...new Set(allProjects.filter(p => p.project_name === projectName && p.tag === tag).map(p => p.version))]
        .forEach(v => { verSelect.innerHTML += `<option value="${v}">${v}</option>`; });
    }
    function getSelectedProjectEntry(projectName, tag, version) {
      return allProjects.find(
        p => p.project_name === projectName && p.tag === tag && String(p.version) === String(version)
      );
    }

    window.onload = loadAllProjects;
    document.getElementById('project').onchange = function() {
      let pname = this.value;
      if (pname) fillTagsDropdown(pname);
      else {
        document.getElementById('tag').innerHTML = '<option value="">Select Tag</option>';
        document.getElementById('version').innerHTML = '<option value="">Select Version</option>';
      }
    };
    document.getElementById('tag').onchange = function() {
      const pname = document.getElementById('project').value;
      const tag = this.value;
      if (pname && tag) fillVersionsDropdown(pname, tag);
      else document.getElementById('version').innerHTML = '<option value="">Select Version</option>';
    };

    document.getElementById('ciForm').onsubmit = function(e) {
      e.preventDefault();
      const project = document.getElementById('project').value;
      const tag = document.getElementById('tag').value;
      const version = document.getElementById('version').value;
      const pzipPassword = document.getElementById('pzip_password').value;
      const pzipPassword2 = document.getElementById('pzip_password2').value;
      const zipPassword = document.getElementById('zip_password').value;
      const zipPassword2 = document.getElementById('zip_password2').value;

      if (!project || !tag || !version) return showError('All fields required!');
      if (!pzipPassword || !pzipPassword2 || !zipPassword || !zipPassword2)
        return showError('Enter all passwords and confirmations.');
      if (pzipPassword !== pzipPassword2)
        return showError('Project zip passwords do not match.');
      if (zipPassword !== zipPassword2)
        return showError('Build zip passwords do not match.');
      // Optionally enforce that build zip password is not the same as project zip password
      if (pzipPassword === zipPassword)
        return showError('Project zip password and build zip password should be different.');

      // Strong password validation: min 8 chars, uppercase, lowercase, number, special char
      let strongPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;
      if (!strongPattern.test(pzipPassword)) {
        return showError('Project zip password must be at least 8 characters and include uppercase, lowercase, a number, and a special character.');
      }
      if (!strongPattern.test(zipPassword)) {
        return showError('Build zip password must be at least 8 characters and include uppercase, lowercase, a number, and a special character.');
      }

      const selected = getSelectedProjectEntry(project, tag, version);
      if (!selected) return showError('Invalid selection.');

      showFlash('Triggering CI...');
      fetch('/trigger-build-ci', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          cid: selected.cid,
          tag: selected.tag,
          zip_password: pzipPassword,           // For decrypting the original zip
          build_zip_password: zipPassword,      // For encrypting the build
          project_name: project
        })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) showFlash('CI triggered successfully!');
        else showError(data.message || 'Trigger failed.');
      })
      .catch(() => showError('Network or server error.'));
    };
  </script>
</body>
</html>
