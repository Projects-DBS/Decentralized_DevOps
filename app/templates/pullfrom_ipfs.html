<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Download a Project - DCICD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="bg-white rounded shadow p-4 mx-auto" style="max-width:400px;">
    <h2 class="mb-4 text-center">Download Project from the Repository</h2>
    <form id="downloadForm" autocomplete="off">
      <select id="projectSelect" class="form-select mb-3" required>
        <option value="">Select a Project</option>
      </select>
      <select id="tagSelect" class="form-select mb-3" required>
        <option value="">Select a Tag</option>
      </select>
      <select id="versionSelect" class="form-select mb-3" required>
        <option value="">Select a Version</option>
      </select>
      <input type="password" id="passInput" class="form-control mb-2" placeholder="Decryption Password" required>
      <div id="errorMsg" class="text-danger small mb-2" style="display:none;"></div>
      <button type="submit" class="btn btn-primary w-100">Download the Project</button>
    </form>
    <div id="statusOutput" class="mt-3 text-success text-center small"></div>
  </div>
</div>
<script>
fetch('/get_projects', {method: 'POST'})
  .then(function(response) {
    return response.json();
  })
  .then(function(data) {
    var allProjects = data.projects || [];
    var projectDropdown = document.getElementById('projectSelect');
    var tagDropdown = document.getElementById('tagSelect');
    var versionDropdown = document.getElementById('versionSelect');
    
    var projectNames = [];
    for (var i = 0; i < allProjects.length; i++) {
      if (projectNames.indexOf(allProjects[i].project_name) === -1) {
        projectNames.push(allProjects[i].project_name);
      }
    }
    
    for (var j = 0; j < projectNames.length; j++) {
      projectDropdown.innerHTML += '<option>' + projectNames[j] + '</option>';
    }
    
    projectDropdown.addEventListener('change', function() {
      tagDropdown.innerHTML = '<option value="">Select a Tag</option>';
      versionDropdown.innerHTML = '<option value="">Select a Version</option>';
      
      var selectedProject = this.value;
      var availableTags = [];
      
      for (var k = 0; k < allProjects.length; k++) {
        if (allProjects[k].project_name === selectedProject && availableTags.indexOf(allProjects[k].tag) === -1) {
          availableTags.push(allProjects[k].tag);
        }
      }
      
      for (var l = 0; l < availableTags.length; l++) {
        tagDropdown.innerHTML += '<option>' + availableTags[l] + '</option>';
      }
    });
    
    tagDropdown.addEventListener('change', function() {
      versionDropdown.innerHTML = '<option value="">Select a Version</option>';
      var selectedProject = projectDropdown.value;
      var selectedTag = this.value;
      
      for (var m = 0; m < allProjects.length; m++) {
        if (allProjects[m].project_name === selectedProject && allProjects[m].tag === selectedTag) {
          var optionText = 'v' + allProjects[m].version + ' [' + allProjects[m].timestamp + ']';
          var optionValue = allProjects[m].cid + '|' + allProjects[m].version;
          versionDropdown.innerHTML += '<option value="' + optionValue + '">' + optionText + '</option>';
        }
      }
    });
  });

function validatePassword(password) {
  if (password.length < 8) return 'At least 8 characters.';
  if (!/[A-Za-z]/.test(password)) return 'Letters needed.';
  if (!/[0-9]/.test(password)) return 'Numbers needed.';
  return '';
}

document.getElementById('downloadForm').addEventListener('submit', function(event) {
  event.preventDefault();
  
  var userPassword = document.getElementById('passInput').value;
  var errorDisplay = document.getElementById('errorMsg');
  var validationMessage = validatePassword(userPassword);
  
  if (validationMessage) {
    errorDisplay.textContent = validationMessage;
    errorDisplay.style.display = "block";
    return;
  } else {
    errorDisplay.style.display = "none";
  }
  
  var versionData = document.getElementById('versionSelect').value.split('|');
  var statusDiv = document.getElementById('statusOutput');
  statusDiv.textContent = 'Preparing download...';
  
  fetch('/download_project', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      cid: versionData[0],
      project_name: document.getElementById('projectSelect').value,
      zip_password: userPassword
    })
  })
  .then(function(response) {
    if (!response.ok) {
      return response.json().then(function(errorData) {
        statusDiv.textContent = 'Error: ' + (errorData.error || 'Download failed.');
        return null;
      });
    }
    return response.blob();
  })
  .then(function(fileBlob) {
    if (!fileBlob) return;
    
    var downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(fileBlob);
    downloadLink.download = document.getElementById('projectSelect').value + '.zip';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    downloadLink.remove();
    statusDiv.textContent = 'Download Initiated';
  });
});
</script>
</body>
</html>