<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CD Trigger - DCICD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container my-5">
    <div class="card shadow">
        <div class="card-body">
            <h1 class="card-title mb-4">CD Trigger</h1>

            <div class="mb-4">
                <h5>Active Servers</h5>
                <ul id="serverList" class="list-group"></ul>
            </div>

            <div class="mb-4">
                <h5>Select Artifact</h5>
                <div class="row g-2 mb-2">
                    <div class="col-md">
                        <label for="projectName" class="form-label">Select a Project</label>
                        <select id="projectName" class="form-select"></select>
                    </div>
                    <div class="col-md">
                        <label for="tag" class="form-label">Tag</label>
                        <select id="tag" class="form-select"></select>
                    </div>
                    <div class="col-md">
                        <label for="version" class="form-label">Select a Version</label>
                        <select id="version" class="form-select"></select>
                    </div>
                </div>
                <div id="selectedCid" class="form-text"></div>
            </div>

            <div class="mb-4">
                <h5>Credentials</h5>
                <div class="row g-2">
                    <div class="col-md">
                        <label for="artifactPassword" class="form-label">Enter the Artifact Password</label>
                        <input type="password" id="artifactPassword" class="form-control">
                    </div>
                    <div class="col-md">
                        <label for="serverPassword" class="form-label">Enter Server Password</label>
                        <input type="password" id="serverPassword" class="form-control">
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h5>Port Availability</h5>
                <button id="checkPortButton" class="btn btn-primary btn-sm me-2 mb-2">Check for Port Availability</button>
                <button id="decommissionButton" class="btn btn-danger btn-sm mb-2">Decommission</button>
                <ul id="portAvailability" class="list-group mt-2"></ul>
            </div>



            <button id="deployButton" class="btn btn-success w-100">Deploy</button>
        </div>
    </div>



    <div class="modal" tabindex="-1" id="loadingModal">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-body">
            <div class="spinner-border text-success mb-3"></div>
            <div id="loadingText">Please wait...</div>
          </div>
        </div>
      </div>
    </div>
</div>

<script>

let selectedCid = null;
let serverIps = [];
let availableIps = [];
let builds = [];

function fetchServers() {
    fetch('/list-active-server')
      .then(res => res.json())
      .then(data => {
          serverIps = data.servers.map(s => s.id);
          let html = data.servers.map(s => `<li class="list-group-item">${s.name}</li>`).join('');
          document.getElementById('serverList').innerHTML = html;
      });
}

function fetchBuildInfo() {
    fetch('/artifact_build_info')
      .then(res => res.json())
      .then(data => {
          builds = data.project_builds;

          let projects = [...new Set(builds.map(b => b.project_name))];
          let tags = [...new Set(builds.map(b => b.tag))];
          let versions = [...new Set(builds.map(b => b.version))];

          setOptions('projectName', projects, 'Project');
          setOptions('tag', tags, 'Tag');
          setOptions('version', versions, 'Version');
      });
}


function setOptions(id, options, label) {
    let el = document.getElementById(id);
    el.innerHTML = `<option value="">Select ${label}</option>` + options.map(v => `<option>${v}</option>`).join('');
}

function updateSelectedCid() {
    let project = document.getElementById('projectName').value;
    let tag = document.getElementById('tag').value;
    let version = document.getElementById('version').value;
    let found = builds.find(b => b.project_name === project && b.tag === tag && b.version === version);
    selectedCid = found ? found.build_cid : null;
    document.getElementById('selectedCid').textContent = selectedCid ? 'Selected CID: ' + selectedCid : '';
}

function checkPortAvailability() {
    let tag = document.getElementById('tag').value;
    if (!tag) { alert('Select a tag'); return; }
    showLoading('Checking port...');
    fetch('/check-port-availability', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tag: tag, ips: serverIps })
    })
    .then(res => res.json())
    .then(data => {
        availableIps = Object.keys(data).filter(ip => data[ip] === 'Available');
        let html = Object.entries(data)
          .map(([ip, status]) =>
            `<li class="list-group-item ${status==='Available'?'text-success':'text-danger'}">
                ${ip}: ${status}
            </li>`).join('');
        document.getElementById('portAvailability').innerHTML = html;
        hideLoading();
    });
}


function decommissionService() {
    let tag = document.getElementById('tag').value;
    let serverPassword = document.getElementById('serverPassword').value;
    if (!tag || !serverPassword) { alert('Fill in all fields'); return; }
    showLoading('Decommissioning......');
    fetch('/check-port-availability', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tag: tag, ips: serverIps })
    })
    .then(res => res.json())
    .then(data => {
        let unavailableIps = Object.keys(data).filter(ip => data[ip] !== 'Available');
        if (unavailableIps.length === 0) {
            alert('No servers to decommission.');
            hideLoading();
            return;
        }


        return fetch('/decommission', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                server_list: unavailableIps,
                deployment_server_password: serverPassword,
                tag: tag
            })
        });
    })
    .then(res => res ? res.json() : null)
    .then(data => {
        if (data && data.status === 'success') alert('Decommission successful!');
        else if (data) alert('Decommission failed: ' + (data.message || ''));
        hideLoading();
    });
}


function deploy() {
    let artifactPassword = document.getElementById('artifactPassword').value;
    let serverPassword = document.getElementById('serverPassword').value;
    let tag = document.getElementById('tag').value;

    if (!selectedCid || !artifactPassword || !serverPassword || !tag || availableIps.length === 0) {
        alert('Please fill in all fields and check port availability!');
        return;
    }
    showLoading('Deploying...');
    fetch('/deploy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            server_list: availableIps,
            build_cid: selectedCid,
            artifact_password: artifactPassword,
            deployment_server_password: serverPassword,
            tag: tag
        })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message || (data.status === 'success' ? 'Deployment successful!' : 'Deployment failed.'));
        hideLoading();
    });
}


function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    let modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    window._loadingModal = modal; 
}
function hideLoading() {
    if (window._loadingModal) window._loadingModal.hide();
}



document.addEventListener('DOMContentLoaded', function() {
    fetchServers();
    fetchBuildInfo();

    document.getElementById('projectName').addEventListener('change', updateSelectedCid);
    document.getElementById('tag').addEventListener('change', updateSelectedCid);
    document.getElementById('version').addEventListener('change', updateSelectedCid);

    document.getElementById('checkPortButton').addEventListener('click', checkPortAvailability);
    document.getElementById('decommissionButton').addEventListener('click', decommissionService);
    document.getElementById('deployButton').addEventListener('click', deploy);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
