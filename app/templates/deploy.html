<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CD Trigger - DCICD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container my-5">
    <div class="card shadow">
        <div class="card-body">
            <h1 class="card-title mb-4">CD Trigger</h1>
            <div class="mb-4">
                <h5>Active Servers</h5>
                <ul id="serverDisplay" class="list-group"></ul>
            </div>
            <div class="mb-4">
                <h5>Select Artifact</h5>
                <div class="row g-2 mb-2">
                    <div class="col-md">
                        <label for="projectDropdown" class="form-label">Select a Project</label>
                        <select id="projectDropdown" class="form-select"></select>
                    </div>
                    <div class="col-md">
                        <label for="tagDropdown" class="form-label">Tag</label>
                        <select id="tagDropdown" class="form-select"></select>
                    </div>
                    <div class="col-md">
                        <label for="versionDropdown" class="form-label">Select a Version</label>
                        <select id="versionDropdown" class="form-select"></select>
                    </div>
                </div>
                <div id="cidInfo" class="form-text"></div>
            </div>
            <div class="mb-4">
                <h5>Credentials</h5>
                <div class="row g-2">
                    <div class="col-md">
                        <label for="buildPassword" class="form-label">Enter the Artifact Password</label>
                        <input type="password" id="buildPassword" class="form-control">
                    </div>
                    <div class="col-md">
                        <label for="deployPassword" class="form-label">Enter Server Password</label>
                        <input type="password" id="deployPassword" class="form-control">
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <h5>Port Availability</h5>
                <button id="portCheckBtn" class="btn btn-primary btn-sm me-2 mb-2">Check for Port Availability</button>
                <button id="removeBtn" class="btn btn-danger btn-sm mb-2">Decommission</button>
                <ul id="portStatus" class="list-group mt-2"></ul>
            </div>
            <button id="startDeployment" class="btn btn-success w-100">Deploy</button>
        </div>
    </div>
    <div class="modal" tabindex="-1" id="progressModal">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-body">
            <div class="spinner-border text-success mb-3"></div>
            <div id="progressMessage">Please wait...</div>
          </div>
        </div>
      </div>
    </div>
</div>
<script>
var currentCid = null;
var machineList = [];
var readyMachines = [];
var buildData = [];

function loadServerList() {
    fetch('/list-active-server')
      .then(function(response) {
          return response.json();
      })
      .then(function(data) {
          machineList = data.servers.map(function(server) {
              return server.id;
          });
          var serverHTML = '';
          for (var i = 0; i < data.servers.length; i++) {
              serverHTML += '<li class="list-group-item">' + data.servers[i].name + '</li>';
          }
          document.getElementById('serverDisplay').innerHTML = serverHTML;
      });
}

function loadBuildData() {
    fetch('/artifact_build_info')
      .then(function(response) {
          return response.json();
      })
      .then(function(data) {
          buildData = data.project_builds;
          var projectNames = [];
          var tagNames = [];
          var versionNumbers = [];
          
          for (var i = 0; i < buildData.length; i++) {
              if (projectNames.indexOf(buildData[i].project_name) === -1) {
                  projectNames.push(buildData[i].project_name);
              }
              if (tagNames.indexOf(buildData[i].tag) === -1) {
                  tagNames.push(buildData[i].tag);
              }
              if (versionNumbers.indexOf(buildData[i].version) === -1) {
                  versionNumbers.push(buildData[i].version);
              }
          }
          
          populateDropdown('projectDropdown', projectNames, 'Project');
          populateDropdown('tagDropdown', tagNames, 'Tag');
          populateDropdown('versionDropdown', versionNumbers, 'Version');
      });
}

function populateDropdown(elementId, options, placeholder) {
    var dropdown = document.getElementById(elementId);
    dropdown.innerHTML = '<option value="">Select ' + placeholder + '</option>';
    for (var i = 0; i < options.length; i++) {
        dropdown.innerHTML += '<option>' + options[i] + '</option>';
    }
}

function updateCidDisplay() {
    var selectedProject = document.getElementById('projectDropdown').value;
    var selectedTag = document.getElementById('tagDropdown').value;
    var selectedVersion = document.getElementById('versionDropdown').value;
    
    var matchingBuild = null;
    for (var i = 0; i < buildData.length; i++) {
        if (buildData[i].project_name === selectedProject && 
            buildData[i].tag === selectedTag && 
            buildData[i].version === selectedVersion) {
            matchingBuild = buildData[i];
            break;
        }
    }
    
    currentCid = matchingBuild ? matchingBuild.build_cid : null;
    document.getElementById('cidInfo').textContent = currentCid ? 'Selected CID: ' + currentCid : '';
}

function checkPorts() {
    var selectedTag = document.getElementById('tagDropdown').value;
    if (!selectedTag) { 
        alert('Select a tag'); 
        return; 
    }
    
    displayProgress('Checking port...');
    fetch('/check-port-availability', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tag: selectedTag, ips: machineList })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        readyMachines = [];
        var statusHTML = '';
        
        for (var ip in data) {
            if (data[ip] === 'Available') {
                readyMachines.push(ip);
                statusHTML += '<li class="list-group-item text-success">' + ip + ': ' + data[ip] + '</li>';
            } else {
                statusHTML += '<li class="list-group-item text-danger">' + ip + ': ' + data[ip] + '</li>';
            }
        }
        
        document.getElementById('portStatus').innerHTML = statusHTML;
        closeProgress();
    });
}

function removeServices() {
    var selectedTag = document.getElementById('tagDropdown').value;
    var serverPass = document.getElementById('deployPassword').value;
    
    if (!selectedTag || !serverPass) { 
        alert('Fill in all fields'); 
        return; 
    }
    
    displayProgress('Decommissioning......');
    fetch('/check-port-availability', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tag: selectedTag, ips: machineList })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        var busyMachines = [];
        for (var ip in data) {
            if (data[ip] !== 'Available') {
                busyMachines.push(ip);
            }
        }
        
        if (busyMachines.length === 0) {
            alert('No servers to decommission.');
            closeProgress();
            return;
        }
        
        return fetch('/decommission', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                server_list: busyMachines,
                deployment_server_password: serverPass,
                tag: selectedTag
            })
        });
    })
    .then(function(response) {
        if (response) {
            return response.json();
        }
        return null;
    })
    .then(function(result) {
        if (result && result.status === 'success') {
            alert('Decommission successful!');
        } else if (result) {
            alert('Decommission failed: ' + (result.message || ''));
        }
        closeProgress();
    });
}

function startDeploy() {
    var buildPass = document.getElementById('buildPassword').value;
    var serverPass = document.getElementById('deployPassword').value;
    var selectedTag = document.getElementById('tagDropdown').value;
    
    if (!currentCid || !buildPass || !serverPass || !selectedTag || readyMachines.length === 0) {
        alert('Please fill in all fields and check port availability!');
        return;
    }
    
    displayProgress('Deploying...');
    fetch('/deploy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            server_list: readyMachines,
            build_cid: currentCid,
            artifact_password: buildPass,
            deployment_server_password: serverPass,
            tag: selectedTag
        })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(result) {
        var message = result.message || (result.status === 'success' ? 'Deployment successful!' : 'Deployment failed.');
        alert(message);
        closeProgress();
    });
}

function displayProgress(message) {
    document.getElementById('progressMessage').textContent = message;
    var modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
    window.activeModal = modal; 
}

function closeProgress() {
    if (window.activeModal) {
        window.activeModal.hide();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadServerList();
    loadBuildData();
    
    document.getElementById('projectDropdown').addEventListener('change', updateCidDisplay);
    document.getElementById('tagDropdown').addEventListener('change', updateCidDisplay);
    document.getElementById('versionDropdown').addEventListener('change', updateCidDisplay);
    document.getElementById('portCheckBtn').addEventListener('click', checkPorts);
    document.getElementById('removeBtn').addEventListener('click', removeServices);
    document.getElementById('startDeployment').addEventListener('click', startDeploy);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>